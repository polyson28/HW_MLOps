services:

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    ports:
      - "9000:9000"
      - "9001:9001" 
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345
    volumes:
      - minio_data:/data

  minio-init:
    image: minio/mc:latest
    depends_on:
      - minio
    entrypoint: >
      /bin/sh -c "
      until mc alias set local http://minio:9000 $$MINIO_ROOT_USER $$MINIO_ROOT_PASSWORD; do
        echo 'Waiting for Minio...';
        sleep 1;
      done;
      mc mb -p local/mlops || true;
      exit 0;
      "
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio12345

  rest-api:
    build: .
    container_name: ml-service-rest-api
    command: python rest_api.py
    ports:
      - "8000:8000"
    volumes:
      - ./storage:/app/storage
    environment:
    - MODEL_STORAGE_DIR=/app/storage
    - DVC_REPO_DIR=/app/storage/dvc_repo
    - DATASETS_DIR=/app/storage/datasets
    - S3_ENDPOINT_URL=http://minio:9000
    - S3_BUCKET=mlops
    - AWS_ACCESS_KEY_ID=minio
    - AWS_SECRET_ACCESS_KEY=minio12345
    - AWS_DEFAULT_REGION=us-east-1
    networks:
      - ml-network

  grpc-server:
    build: .
    container_name: ml-service-grpc
    command: python grpc_service/grpc_server.py
    ports:
      - "50051:50051"
    environment:
    - MODEL_STORAGE_DIR=/app/storage
    - DVC_REPO_DIR=/app/storage/dvc_repo
    - DATASETS_DIR=/app/storage/datasets
    - S3_ENDPOINT_URL=http://minio:9000
    - S3_BUCKET=mlops
    - AWS_ACCESS_KEY_ID=minio
    - AWS_SECRET_ACCESS_KEY=minio12345
    - AWS_DEFAULT_REGION=us-east-1
    volumes:
      - ./storage:/app/storage
    networks:
      - ml-network

  dashboard:
    build: .
    container_name: ml-service-dashboard
    command: streamlit run dashboard.py --server.port=8501 --server.address=0.0.0.0
    ports:
      - "8501:8501"
    environment:
      - REST_API_URL=http://rest-api:8000
    networks:
      - ml-network
    depends_on:
      - rest-api

networks:
  ml-network:
    driver: bridge

volumes:
  minio_data: {}
